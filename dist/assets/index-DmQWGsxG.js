var I=Object.defineProperty;var b=(d,t,e)=>t in d?I(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var h=(d,t,e)=>b(d,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class E{constructor(t){h(this,"previewCanvas");h(this,"previewCtx");h(this,"fullResCanvas",null);h(this,"fullResCtx",null);h(this,"currentImage",null);this.previewCanvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2d context");this.previewCtx=e}setImage(t){if(this.currentImage=t,this.fullResCanvas=new OffscreenCanvas(t.width,t.height),this.fullResCtx=this.fullResCanvas.getContext("2d"),!this.fullResCtx)throw new Error("Could not get offscreen context");this.fullResCtx.drawImage(t,0,0),this.updatePreview()}getImage(){return this.currentImage}getFullResCanvas(){return this.fullResCanvas}getFullResContext(){return this.fullResCtx}updatePreview(t){if(!this.currentImage)return;const e=this.previewCanvas.parentElement;if(!e)return;const i=e.getBoundingClientRect(),s=40,n=i.width-s,r=i.height-s,a=this.currentImage.width/this.currentImage.height,c=n/r;let o,l;a>c?(o=Math.min(n,this.currentImage.width),l=o/a):(l=Math.min(r,this.currentImage.height),o=l*a),this.previewCanvas.width=o,this.previewCanvas.height=l,this.previewCtx.save(),t&&(this.previewCtx.filter=t),this.previewCtx.drawImage(this.currentImage,0,0,o,l),this.previewCtx.restore()}getPreviewCanvas(){return this.previewCanvas}getPreviewContext(){return this.previewCtx}drawOnPreview(t,e){this.updatePreview(e),t(this.previewCtx)}getPreviewScale(){return this.currentImage?this.previewCanvas.width/this.currentImage.width:1}async exportAsBlob(t,e=.92){if(!this.fullResCanvas)throw new Error("No image loaded");const i=t==="png"?"image/png":"image/jpeg";return await this.fullResCanvas.convertToBlob({type:i,quality:e})}clear(){this.currentImage=null,this.fullResCanvas=null,this.fullResCtx=null,this.previewCtx.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height),this.previewCanvas.width=0,this.previewCanvas.height=0}}class C{constructor(){h(this,"entries",[]);h(this,"currentIndex",-1);h(this,"maxEntries",50)}push(t,e){this.currentIndex<this.entries.length-1&&(this.entries=this.entries.slice(0,this.currentIndex+1)),this.entries.push({image:t,description:e}),this.currentIndex=this.entries.length-1,this.entries.length>this.maxEntries&&(this.entries.shift(),this.currentIndex--)}undo(){return this.canUndo()?(this.currentIndex--,this.entries[this.currentIndex]):null}redo(){return this.canRedo()?(this.currentIndex++,this.entries[this.currentIndex]):null}canUndo(){return this.currentIndex>0}canRedo(){return this.currentIndex<this.entries.length-1}current(){return this.currentIndex<0?null:this.entries[this.currentIndex]}clear(){this.entries=[],this.currentIndex=-1}}class p{async createImageBitmap(t){return await createImageBitmap(t)}}class f extends p{constructor(t){super(),this.horizontal=t}async apply(t,e){const i=new OffscreenCanvas(e.width,e.height),s=i.getContext("2d");if(!s)throw new Error("Could not get context");return s.save(),this.horizontal?(s.translate(e.width,0),s.scale(-1,1)):(s.translate(0,e.height),s.scale(1,-1)),s.drawImage(e,0,0),s.restore(),this.createImageBitmap(i)}getDescription(){return this.horizontal?"Flip Horizontal":"Flip Vertical"}}class x extends p{constructor(t){super(),this.degrees=t}async apply(t,e){const i=this.degrees*Math.PI/180,s=Math.abs(Math.sin(i)),n=Math.abs(Math.cos(i)),r=Math.round(e.width*n+e.height*s),a=Math.round(e.width*s+e.height*n),c=new OffscreenCanvas(r,a),o=c.getContext("2d");if(!o)throw new Error("Could not get context");return o.save(),o.translate(r/2,a/2),o.rotate(i),o.drawImage(e,-e.width/2,-e.height/2),o.restore(),this.createImageBitmap(c)}getDescription(){return`Rotate ${this.degrees}Â°`}}class B extends p{constructor(t){super(),this.region=t}async apply(t,e){const{x:i,y:s,width:n,height:r}=this.region,a=Math.max(0,Math.min(i,e.width)),c=Math.max(0,Math.min(s,e.height)),o=Math.max(1,Math.min(n,e.width-a)),l=Math.max(1,Math.min(r,e.height-c)),u=new OffscreenCanvas(o,l),g=u.getContext("2d");if(!g)throw new Error("Could not get context");return g.drawImage(e,a,c,o,l,0,0,o,l),this.createImageBitmap(u)}getDescription(){return`Crop to ${Math.round(this.region.width)}x${Math.round(this.region.height)}`}}class L extends p{constructor(t,e){super(),this.secondImage=t,this.position=e}async apply(t,e){let i,s,n=0,r=0,a=0,c=0,o=this.secondImage.width,l=this.secondImage.height;if(this.position==="left"||this.position==="right"){const w=e.height/this.secondImage.height;o=Math.round(this.secondImage.width*w),l=e.height,s=e.height,i=e.width+o,this.position==="left"?(n=o,a=0):(n=0,a=e.width)}else{const w=e.width/this.secondImage.width;o=e.width,l=Math.round(this.secondImage.height*w),i=e.width,s=e.height+l,this.position==="top"?(r=l,c=0):(r=0,c=e.height)}const u=new OffscreenCanvas(i,s),g=u.getContext("2d");if(!g)throw new Error("Could not get context");return g.drawImage(e,n,r),g.drawImage(this.secondImage,a,c,o,l),this.createImageBitmap(u)}getDescription(){return`Merge image (${this.position})`}}class m extends p{constructor(t){super(),this.adjustments=t}async apply(t,e){const i=new OffscreenCanvas(e.width,e.height),s=i.getContext("2d");if(!s)throw new Error("Could not get context");const{brightness:n,contrast:r,saturation:a}=this.adjustments;return s.filter=`brightness(${n}%) contrast(${r}%) saturate(${a}%)`,s.drawImage(e,0,0),this.createImageBitmap(i)}getDescription(){const{brightness:t,contrast:e,saturation:i}=this.adjustments;return`Adjust (B:${t}% C:${e}% S:${i}%)`}static buildFilter(t){const{brightness:e,contrast:i,saturation:s}=t;return`brightness(${e}%) contrast(${i}%) saturate(${s}%)`}}class v extends p{constructor(t){super(),this.shape=t}async apply(t,e){const i=new OffscreenCanvas(e.width,e.height),s=i.getContext("2d");if(!s)throw new Error("Could not get context");return s.drawImage(e,0,0),v.draw(s,this.shape),this.createImageBitmap(i)}static draw(t,e){const{x:i,y:s,width:n,height:r,color:a,lineWidth:c,filled:o}=e;t.save(),t.strokeStyle=a,t.fillStyle=a,t.lineWidth=c,e.type==="rect"?o?t.fillRect(i,s,n,r):t.strokeRect(i,s,n,r):(t.beginPath(),t.ellipse(i+n/2,s+r/2,Math.abs(n/2),Math.abs(r/2),0,0,Math.PI*2),o?t.fill():t.stroke()),t.restore()}getDescription(){return`Draw ${this.shape.type}`}}const S={brightness:100,contrast:100,saturation:100};function y(d){return d.brightness===100&&d.contrast===100&&d.saturation===100}class M{constructor(t,e){h(this,"canvas");h(this,"history");h(this,"onStateChange");h(this,"pendingAdjustments",null);this.canvas=new E(t),this.history=new C,this.onStateChange=e}async loadImage(t){const e=await createImageBitmap(t);this.canvas.setImage(e),this.history.clear(),this.history.push(e,"Original"),this.onStateChange()}async applyOperation(t){const e=this.canvas.getImage();if(!e)return;const i=this.canvas.getFullResContext();if(!i)return;const s=await t.apply(i,e);this.canvas.setImage(s),this.history.push(s,t.getDescription()),this.onStateChange()}async flipHorizontal(){await this.applyOperation(new f(!0))}async flipVertical(){await this.applyOperation(new f(!1))}async rotate(t){await this.applyOperation(new x(t))}async crop(t){await this.applyOperation(new B(t))}async merge(t,e){const i=await createImageBitmap(t);await this.applyOperation(new L(i,e))}async applyAdjustments(t){await this.applyOperation(new m(t))}setPendingAdjustments(t){this.pendingAdjustments=t;const e=m.buildFilter(t);this.canvas.updatePreview(e)}clearPendingAdjustments(){this.pendingAdjustments=null,this.canvas.updatePreview()}hasPendingAdjustments(){return this.pendingAdjustments!==null&&!y(this.pendingAdjustments)}async flushAdjustments(){this.pendingAdjustments&&!y(this.pendingAdjustments)&&await this.applyAdjustments(this.pendingAdjustments),this.pendingAdjustments=null,this.canvas.updatePreview()}resetPreview(){this.pendingAdjustments=null,this.canvas.updatePreview()}drawOnPreview(t){const e=this.pendingAdjustments?m.buildFilter(this.pendingAdjustments):void 0;this.canvas.drawOnPreview(t,e)}refreshPreview(){const t=this.pendingAdjustments?m.buildFilter(this.pendingAdjustments):void 0;this.canvas.updatePreview(t)}async applyShape(t){await this.applyOperation(new v(t))}getDefaultAdjustments(){return{...S}}undo(){const t=this.history.undo();t&&(this.canvas.setImage(t.image),this.onStateChange())}redo(){const t=this.history.redo();t&&(this.canvas.setImage(t.image),this.onStateChange())}canUndo(){return this.history.canUndo()}canRedo(){return this.history.canRedo()}hasImage(){return this.canvas.getImage()!==null}async exportAsBlob(t){return this.canvas.exportAsBlob(t)}getPreviewCanvas(){return this.canvas.getPreviewCanvas()}getPreviewScale(){return this.canvas.getPreviewScale()}getImageDimensions(){const t=this.canvas.getImage();return t?{width:t.width,height:t.height}:null}}class A{constructor(t){h(this,"editor");this.editor=t,this.setupEventListeners()}setupEventListeners(){var e,i,s,n,r,a,c;document.getElementById("upload-input").addEventListener("change",async o=>{var u;const l=(u=o.target.files)==null?void 0:u[0];l&&await this.editor.loadImage(l)}),(e=document.getElementById("undo-btn"))==null||e.addEventListener("click",()=>{this.editor.undo()}),(i=document.getElementById("redo-btn"))==null||i.addEventListener("click",()=>{this.editor.redo()}),(s=document.getElementById("download-btn"))==null||s.addEventListener("click",async()=>{await this.editor.flushAdjustments();const o=document.getElementById("export-format").value,l=await this.editor.exportAsBlob(o),u=URL.createObjectURL(l),g=document.createElement("a");g.href=u,g.download=`edited-image.${o}`,g.click(),URL.revokeObjectURL(u)}),(n=document.getElementById("flip-h-btn"))==null||n.addEventListener("click",()=>{this.editor.flipHorizontal()}),(r=document.getElementById("flip-v-btn"))==null||r.addEventListener("click",()=>{this.editor.flipVertical()}),(a=document.getElementById("rotate-cw-btn"))==null||a.addEventListener("click",()=>{this.editor.rotate(90)}),(c=document.getElementById("rotate-ccw-btn"))==null||c.addEventListener("click",()=>{this.editor.rotate(-90)})}updateState(){var r;const t=this.editor.hasImage(),e=this.editor.canUndo(),i=this.editor.canRedo();document.getElementById("undo-btn").disabled=!e,document.getElementById("redo-btn").disabled=!i,document.getElementById("download-btn").disabled=!t,document.getElementById("flip-h-btn").disabled=!t,document.getElementById("flip-v-btn").disabled=!t,document.getElementById("rotate-cw-btn").disabled=!t,document.getElementById("rotate-ccw-btn").disabled=!t,document.getElementById("crop-btn").disabled=!t;const s=document.getElementById("merge-input"),n=document.getElementById("merge-label");s.disabled=!t,n.classList.toggle("disabled",!t),document.getElementById("shape-filled-btn").disabled=!t,document.getElementById("shape-line-width").disabled=!t,document.getElementById("shape-color").disabled=!t,(r=document.getElementById("no-image-message"))==null||r.classList.toggle("hidden",t)}}class P{constructor(t){h(this,"editor");h(this,"brightnessSlider");h(this,"contrastSlider");h(this,"saturationSlider");h(this,"brightnessValue");h(this,"contrastValue");h(this,"saturationValue");h(this,"resetBtn");this.editor=t,this.brightnessSlider=document.getElementById("brightness-slider"),this.contrastSlider=document.getElementById("contrast-slider"),this.saturationSlider=document.getElementById("saturation-slider"),this.brightnessValue=document.getElementById("brightness-value"),this.contrastValue=document.getElementById("contrast-value"),this.saturationValue=document.getElementById("saturation-value"),this.resetBtn=document.getElementById("reset-adjustments-btn"),this.setupEventListeners()}setupEventListeners(){const t=()=>{const e=this.getValues();this.updateLabels(e),this.editor.setPendingAdjustments(e)};this.brightnessSlider.addEventListener("input",t),this.contrastSlider.addEventListener("input",t),this.saturationSlider.addEventListener("input",t),this.resetBtn.addEventListener("click",()=>{this.resetSliderValues(),this.editor.resetPreview()})}getValues(){return{brightness:parseInt(this.brightnessSlider.value),contrast:parseInt(this.contrastSlider.value),saturation:parseInt(this.saturationSlider.value)}}updateLabels(t){this.brightnessValue.textContent=`${t.brightness}%`,this.contrastValue.textContent=`${t.contrast}%`,this.saturationValue.textContent=`${t.saturation}%`}resetSliderValues(){this.brightnessSlider.value="100",this.contrastSlider.value="100",this.saturationSlider.value="100",this.updateLabels({brightness:100,contrast:100,saturation:100})}updateState(){const t=this.editor.hasImage();this.brightnessSlider.disabled=!t,this.contrastSlider.disabled=!t,this.saturationSlider.disabled=!t,this.resetBtn.disabled=!t,this.editor.hasPendingAdjustments()||this.resetSliderValues()}}class R{constructor(t,e=()=>{}){h(this,"editor");h(this,"overlay");h(this,"cropBtn");h(this,"isActive",!1);h(this,"isDragging",!1);h(this,"startX",0);h(this,"startY",0);h(this,"selection",null);this.onActivate=e,this.editor=t,this.overlay=document.getElementById("crop-overlay"),this.cropBtn=document.getElementById("crop-btn"),this.setupEventListeners()}setupEventListeners(){this.cropBtn.addEventListener("click",()=>{this.isActive?this.applyCrop():this.startCropMode()});const t=this.editor.getPreviewCanvas(),e=t.parentElement;e.addEventListener("mousedown",i=>{if(!this.isActive)return;this.isDragging=!0;const s=t.getBoundingClientRect();this.startX=i.clientX-s.left,this.startY=i.clientY-s.top,this.updateOverlay(this.startX,this.startY,0,0),this.overlay.classList.remove("hidden")}),e.addEventListener("mousemove",i=>{if(!this.isDragging)return;const s=t.getBoundingClientRect(),n=i.clientX-s.left,r=i.clientY-s.top,a=Math.min(this.startX,n),c=Math.min(this.startY,r),o=Math.abs(n-this.startX),l=Math.abs(r-this.startY);this.updateOverlay(a,c,o,l)}),e.addEventListener("mouseup",()=>{this.isDragging&&(this.isDragging=!1)}),document.addEventListener("keydown",i=>{i.key==="Escape"&&this.isActive&&this.cancelCrop()})}updateOverlay(t,e,i,s){const n=this.editor.getPreviewCanvas(),r=n.getBoundingClientRect(),a=n.parentElement.getBoundingClientRect(),c=r.left-a.left,o=r.top-a.top;this.overlay.style.left=`${c+t}px`,this.overlay.style.top=`${o+e}px`,this.overlay.style.width=`${i}px`,this.overlay.style.height=`${s}px`,this.selection={x:t,y:e,width:i,height:s}}startCropMode(){this.onActivate(),this.isActive=!0,this.cropBtn.textContent="Apply Crop",this.cropBtn.classList.add("btn-primary"),this.editor.getPreviewCanvas().style.cursor="crosshair"}deactivate(){this.isActive&&this.cancelCrop()}async applyCrop(){if(this.selection&&this.selection.width>0&&this.selection.height>0){await this.editor.flushAdjustments();const t=this.editor.getPreviewScale(),e={x:Math.round(this.selection.x/t),y:Math.round(this.selection.y/t),width:Math.round(this.selection.width/t),height:Math.round(this.selection.height/t)};await this.editor.crop(e)}this.cancelCrop()}cancelCrop(){this.isActive=!1,this.isDragging=!1,this.selection=null,this.cropBtn.textContent="Crop",this.cropBtn.classList.remove("btn-primary"),this.overlay.classList.add("hidden"),this.editor.getPreviewCanvas().style.cursor=""}}class O{constructor(t){h(this,"editor");h(this,"dialog");h(this,"pendingFile",null);this.editor=t,this.dialog=document.getElementById("merge-dialog"),this.setupEventListeners()}setupEventListeners(){var e;const t=document.getElementById("merge-input");t.addEventListener("change",i=>{var n;const s=(n=i.target.files)==null?void 0:n[0];s&&(this.pendingFile=s,this.show()),t.value=""}),this.dialog.querySelectorAll("[data-position]").forEach(i=>{i.addEventListener("click",async()=>{const s=i.getAttribute("data-position");this.pendingFile&&(await this.editor.flushAdjustments(),await this.editor.merge(this.pendingFile,s)),this.hide()})}),(e=document.getElementById("merge-cancel"))==null||e.addEventListener("click",()=>{this.hide()}),this.dialog.addEventListener("click",i=>{i.target===this.dialog&&this.hide()})}show(){this.dialog.classList.remove("hidden")}hide(){this.dialog.classList.add("hidden"),this.pendingFile=null}}class j{constructor(t,e){h(this,"editor");h(this,"onActivate");h(this,"activeTool",null);h(this,"isDragging",!1);h(this,"startX",0);h(this,"startY",0);this.editor=t,this.onActivate=e,this.setupEventListeners()}setupEventListeners(){var i,s,n;(i=document.getElementById("shape-rect-btn"))==null||i.addEventListener("click",()=>this.toggleTool("rect")),(s=document.getElementById("shape-circle-btn"))==null||s.addEventListener("click",()=>this.toggleTool("circle")),(n=document.getElementById("shape-filled-btn"))==null||n.addEventListener("click",r=>{const a=r.currentTarget,c=a.dataset.filled!=="true";a.dataset.filled=String(c),a.textContent=c?"Filled":"Outline"});const t=this.editor.getPreviewCanvas(),e=t.parentElement;e.addEventListener("mousedown",r=>{if(!this.activeTool)return;this.isDragging=!0;const a=t.getBoundingClientRect();this.startX=r.clientX-a.left,this.startY=r.clientY-a.top}),e.addEventListener("mousemove",r=>{if(!this.isDragging)return;const a=t.getBoundingClientRect(),c=r.clientX-a.left,o=r.clientY-a.top;this.renderPreview(c,o)}),e.addEventListener("mouseup",async r=>{if(!this.isDragging)return;this.isDragging=!1;const a=t.getBoundingClientRect(),c=r.clientX-a.left,o=r.clientY-a.top,l=Math.abs(c-this.startX),u=Math.abs(o-this.startY);l>2&&u>2?await this.commit(c,o):this.editor.refreshPreview()}),document.addEventListener("keydown",r=>{r.key==="Escape"&&this.activeTool&&this.deactivate()})}toggleTool(t){if(this.activeTool===t){this.deactivate();return}this.onActivate(),this.activeTool=t,this.editor.getPreviewCanvas().style.cursor="crosshair",this.updateButtonStates()}renderPreview(t,e){const i=Math.min(this.startX,t),s=Math.min(this.startY,e),n=Math.abs(t-this.startX),r=Math.abs(e-this.startY),a=this.buildPreviewShape(i,s,n,r);this.editor.drawOnPreview(c=>v.draw(c,a))}async commit(t,e){const i=this.editor.getPreviewScale(),s=Math.min(this.startX,t),n=Math.min(this.startY,e),r=Math.abs(t-this.startX),a=Math.abs(e-this.startY),c=this.buildPreviewShape(s,n,r,a),o={...c,x:Math.round(s/i),y:Math.round(n/i),width:Math.round(r/i),height:Math.round(a/i),lineWidth:Math.round(c.lineWidth/i)};await this.editor.applyShape(o)}buildPreviewShape(t,e,i,s){const n=document.getElementById("shape-color"),r=document.getElementById("shape-filled-btn"),a=document.getElementById("shape-line-width");return{type:this.activeTool,x:t,y:e,width:i,height:s,color:n.value,filled:r.dataset.filled==="true",lineWidth:parseInt(a.value)}}deactivate(){this.activeTool=null,this.isDragging=!1,this.editor.getPreviewCanvas().style.cursor="",this.editor.refreshPreview(),this.updateButtonStates()}updateButtonStates(){const t=document.getElementById("shape-rect-btn"),e=document.getElementById("shape-circle-btn");t.classList.toggle("btn-primary",this.activeTool==="rect"),e.classList.toggle("btn-primary",this.activeTool==="circle")}updateState(){const t=this.editor.hasImage();document.getElementById("shape-rect-btn").disabled=!t,document.getElementById("shape-circle-btn").disabled=!t}}function D(){const d=document.getElementById("preview-canvas");let t,e,i;const s=()=>{t.updateState(),e.updateState(),i.updateState()},n=new M(d,s);t=new A(n),e=new P(n);let r;i=new j(n,()=>r.deactivate()),r=new R(n,()=>i.deactivate()),new O(n),window.addEventListener("resize",()=>{n.hasImage()&&n.refreshPreview()})}document.addEventListener("DOMContentLoaded",D);
