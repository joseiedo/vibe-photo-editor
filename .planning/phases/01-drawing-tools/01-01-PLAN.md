---
phase: 01-drawing-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types.ts
  - src/operations/PencilOperation.ts
  - src/operations/LineOperation.ts
autonomous: true
requirements: [DRAW-01, DRAW-04, HIST-01]

must_haves:
  truths:
    - "PencilOperation can replay a collected array of canvas points as a single freehand stroke at full resolution"
    - "LineOperation can draw a straight line with an optional filled arrowhead at full resolution"
    - "Both operations integrate with the existing BaseOperation / applyOperation() / history stack pattern without modification"
  artifacts:
    - path: "src/types.ts"
      provides: "Point, PencilStroke, LineData type definitions"
      contains: "Point, PencilStroke, LineData"
    - path: "src/operations/PencilOperation.ts"
      provides: "Full-res freehand stroke rendering via OffscreenCanvas"
      exports: ["PencilOperation"]
      min_lines: 40
    - path: "src/operations/LineOperation.ts"
      provides: "Full-res straight-line + arrowhead rendering via OffscreenCanvas"
      exports: ["LineOperation"]
      min_lines: 50
  key_links:
    - from: "src/operations/PencilOperation.ts"
      to: "src/operations/Operation.ts"
      via: "extends BaseOperation"
      pattern: "extends BaseOperation"
    - from: "src/operations/LineOperation.ts"
      to: "src/operations/Operation.ts"
      via: "extends BaseOperation"
      pattern: "extends BaseOperation"
    - from: "src/operations/PencilOperation.ts"
      to: "src/types.ts"
      via: "PencilStroke import"
      pattern: "import.*PencilStroke"
    - from: "src/operations/LineOperation.ts"
      to: "src/types.ts"
      via: "LineData import"
      pattern: "import.*LineData"
---

<objective>
Add the two new type definitions (PencilStroke, LineData, Point) to types.ts and implement PencilOperation and LineOperation — the full-resolution rendering classes that form the foundation for the pencil and line drawing tools.

Purpose: Every drawing action must be committed to history as a discrete, replayable operation. These classes are the command objects that OffscreenCanvas-render the stroke at full resolution and get pushed onto the history stack via the existing applyOperation() path.

Output: src/types.ts with new types, src/operations/PencilOperation.ts, src/operations/LineOperation.ts
</objective>

<execution_context>
@/Users/iedo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/iedo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-drawing-tools/01-RESEARCH.md
@src/types.ts
@src/operations/Operation.ts
@src/operations/ShapeOperation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Point, PencilStroke, and LineData types to types.ts</name>
  <files>src/types.ts</files>
  <action>
Open src/types.ts and append three new interface/type definitions after the existing ShapeData interface. Follow the exact style of existing types (PascalCase, explicit field types, no JSDoc):

```typescript
export interface Point {
  x: number;
  y: number;
}

export interface PencilStroke {
  points: Point[];
  color: string;
  lineWidth: number;
}

export interface LineData {
  x1: number;
  y1: number;
  x2: number;
  y2: number;
  color: string;
  lineWidth: number;
  arrowhead: boolean;
}
```

Do NOT remove or reorder any existing types. Place these immediately after the ShapeData interface block.
  </action>
  <verify>
    <automated>cd /Users/iedo/Study/photo-editor && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Confirm Point, PencilStroke, LineData appear in src/types.ts with correct field names</manual>
  </verify>
  <done>TypeScript compiles without errors; types.ts exports Point, PencilStroke, and LineData interfaces</done>
</task>

<task type="auto">
  <name>Task 2: Implement PencilOperation</name>
  <files>src/operations/PencilOperation.ts</files>
  <action>
Create src/operations/PencilOperation.ts. Follow the ShapeOperation.ts structure exactly (extend BaseOperation, OffscreenCanvas in apply(), static draw() method for reuse in preview rendering).

Key requirements:
- Constructor accepts `private stroke: PencilStroke`
- `apply()` creates an OffscreenCanvas at image dimensions, draws the existing image, calls `PencilOperation.draw()`, returns new ImageBitmap via `this.createImageBitmap(canvas)`
- Static `draw(ctx, stroke)` handles both preview canvas (CanvasRenderingContext2D) and full-res (OffscreenCanvasRenderingContext2D) — use union type `CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D`
- Drawing logic: `ctx.save()`, set `strokeStyle`, `lineWidth`, `lineCap: 'round'`, `lineJoin: 'round'`, `beginPath()`, `moveTo(points[0])`, loop `lineTo(points[i])` for i >= 1, `stroke()`, `ctx.restore()`
- Single-point guard: if `stroke.points.length < 2`, draw a filled circle at the single point using `ctx.arc(x, y, stroke.lineWidth / 2, 0, Math.PI * 2)` + `ctx.fill()` with `fillStyle = stroke.color`
- `getDescription()` returns `'Draw pencil stroke'`

Imports: `BaseOperation` from `./Operation`, `PencilStroke` from `../types`
  </action>
  <verify>
    <automated>cd /Users/iedo/Study/photo-editor && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>PencilOperation.ts exists, extends BaseOperation, has static draw() method, compiles without TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 3: Implement LineOperation</name>
  <files>src/operations/LineOperation.ts</files>
  <action>
Create src/operations/LineOperation.ts. Same structure as PencilOperation (extend BaseOperation, OffscreenCanvas in apply(), static draw() for preview reuse).

Key requirements:
- Constructor accepts `private line: LineData`
- `apply()` creates OffscreenCanvas at image dimensions, draws existing image, calls `LineOperation.draw()`, returns new ImageBitmap
- Static `draw(ctx, line)` union-typed for both context types:
  1. Draw line shaft: `ctx.save()`, set `strokeStyle = line.color`, `lineWidth = line.lineWidth`, `lineCap: 'round'`, `beginPath()`, `moveTo(line.x1, line.y1)`, `lineTo(line.x2, line.y2)`, `stroke()`
  2. If `line.arrowhead === true`, call `LineOperation.drawArrowhead(ctx, line.x1, line.y1, line.x2, line.y2, line.color, line.lineWidth)`
  3. `ctx.restore()`
- Static `drawArrowhead(ctx, x1, y1, x2, y2, color, size)`:
  - `const angle = Math.atan2(y2 - y1, x2 - x1)`
  - `const headLen = Math.max(size * 4, 12)`
  - `ctx.save()`, `fillStyle = color`, `beginPath()`
  - `moveTo(x2, y2)`
  - `lineTo(x2 - headLen * Math.cos(angle - Math.PI / 6), y2 - headLen * Math.sin(angle - Math.PI / 6))`
  - `lineTo(x2 - headLen * Math.cos(angle + Math.PI / 6), y2 - headLen * Math.sin(angle + Math.PI / 6))`
  - `closePath()`, `fill()`, `ctx.restore()`
- `getDescription()` returns `'Draw line'`

Imports: `BaseOperation` from `./Operation`, `LineData` from `../types`
  </action>
  <verify>
    <automated>cd /Users/iedo/Study/photo-editor && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>LineOperation.ts exists, extends BaseOperation, has static draw() and drawArrowhead() methods, compiles without TypeScript errors</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` from the project root. Zero errors expected. Confirm:
- src/types.ts contains Point, PencilStroke, LineData interfaces
- src/operations/PencilOperation.ts and LineOperation.ts each extend BaseOperation and export their class
- Both operations have a static draw() method callable with either context type
</verification>

<success_criteria>
- `npx tsc --noEmit` exits 0 with no errors
- PencilOperation and LineOperation follow the exact same structural pattern as ShapeOperation
- Static draw() methods are callable from ShapeDrawer during preview rendering (Plan 02 dependency)
</success_criteria>

<output>
After completion, create `.planning/phases/01-drawing-tools/01-01-SUMMARY.md` using the summary template.
</output>
