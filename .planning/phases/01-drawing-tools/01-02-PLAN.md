---
phase: 01-drawing-tools
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - src/ui/ShapeDrawer.ts
  - src/editor/ImageEditor.ts
  - index.html
  - src/ui/KeyboardShortcuts.ts
autonomous: true
requirements: [DRAW-01, DRAW-02, DRAW-03, DRAW-04, UI-01, HIST-01]

must_haves:
  truths:
    - "ShapeDrawer handles pencil, line, rect, and circle tool modes from a single controller"
    - "Pencil tool collects points during mousemove and commits a single PencilOperation on mouseup"
    - "Line tool tracks drag start/end during mousemove with live preview, commits LineOperation on mouseup"
    - "Rect and circle tools continue to function exactly as before (no regression)"
    - "Pencil (P) and Line (L) keyboard shortcuts activate their respective tools"
    - "ImageEditor exposes applyPencil() and applyLine() methods that delegate to applyOperation()"
    - "panel-draw HTML contains pencil button, line button, and arrowhead checkbox"
  artifacts:
    - path: "src/ui/ShapeDrawer.ts"
      provides: "Unified drawing controller for all four tools"
      contains: "pencil|line|activeTool|pencilPoints|arrowheadEnabled"
      min_lines: 150
    - path: "src/editor/ImageEditor.ts"
      provides: "applyPencil() and applyLine() editor facade methods"
      contains: "applyPencil|applyLine"
    - path: "index.html"
      provides: "pencil button, line button, arrowhead checkbox in panel-draw"
      contains: "draw-pencil-btn|draw-line-btn|draw-arrowhead"
    - path: "src/ui/KeyboardShortcuts.ts"
      provides: "P and L key shortcuts for pencil and line tool activation"
      contains: "draw-pencil-btn|draw-line-btn"
  key_links:
    - from: "src/ui/ShapeDrawer.ts"
      to: "src/editor/ImageEditor.ts"
      via: "this.editor.applyPencil() and this.editor.applyLine() calls on mouseup"
      pattern: "applyPencil|applyLine"
    - from: "src/editor/ImageEditor.ts"
      to: "src/operations/PencilOperation.ts"
      via: "new PencilOperation(stroke) passed to applyOperation()"
      pattern: "new PencilOperation"
    - from: "src/editor/ImageEditor.ts"
      to: "src/operations/LineOperation.ts"
      via: "new LineOperation(line) passed to applyOperation()"
      pattern: "new LineOperation"
    - from: "src/ui/ShapeDrawer.ts"
      to: "src/operations/PencilOperation.ts"
      via: "PencilOperation.draw(ctx, stroke) for live preview rendering"
      pattern: "PencilOperation\\.draw"
    - from: "src/ui/ShapeDrawer.ts"
      to: "src/operations/LineOperation.ts"
      via: "LineOperation.draw(ctx, line) for live preview rendering"
      pattern: "LineOperation\\.draw"
---

<objective>
Wire all four drawing tools end-to-end: extend ShapeDrawer to support pencil and line tool modes, add applyPencil() and applyLine() methods to ImageEditor, add HTML controls to panel-draw, and add P/L keyboard shortcuts.

Purpose: The operations from Plan 01 are useless without UI that activates them. This plan connects the tool buttons → ShapeDrawer event handling → ImageEditor facade → applyOperation() → history. After this plan, all four tools (pencil, line, rect, circle) are usable from the Draw tab.

Output: Updated ShapeDrawer.ts, ImageEditor.ts, index.html, KeyboardShortcuts.ts
</objective>

<execution_context>
@/Users/iedo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/iedo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-drawing-tools/01-RESEARCH.md
@.planning/phases/01-drawing-tools/01-01-SUMMARY.md
@src/ui/ShapeDrawer.ts
@src/ui/MaskBrush.ts
@src/editor/ImageEditor.ts
@src/ui/KeyboardShortcuts.ts
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add applyPencil() and applyLine() to ImageEditor</name>
  <files>src/editor/ImageEditor.ts</files>
  <action>
Open src/editor/ImageEditor.ts and make two additions:

**1. Import new operations** (add alongside existing operation imports):
```typescript
import { PencilOperation } from '../operations/PencilOperation';
import { LineOperation } from '../operations/LineOperation';
```

**2. Import new types** (extend the existing types import line to include PencilStroke and LineData):
```typescript
import { ..., PencilStroke, LineData } from '../types';
```

**3. Add two new public async methods** (place them adjacent to the existing `applyShape()` method):
```typescript
async applyPencil(stroke: PencilStroke): Promise<void> {
  await this.applyOperation(new PencilOperation(stroke));
}

async applyLine(line: LineData): Promise<void> {
  await this.applyOperation(new LineOperation(line));
}
```

No other changes to ImageEditor.ts. Do not alter applyShape(), applyOperation(), or any existing method.
  </action>
  <verify>
    <automated>cd /Users/iedo/Study/photo-editor && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>ImageEditor.ts has applyPencil() and applyLine() methods; TypeScript compiles clean</done>
</task>

<task type="auto">
  <name>Task 2: Extend ShapeDrawer with pencil and line tool modes</name>
  <files>src/ui/ShapeDrawer.ts</files>
  <action>
Extend the existing ShapeDrawer.ts to support pencil and line tools. Read the current file carefully before making any changes to understand the existing structure (tool toggle pattern, mouse event handling, renderPreview(), commit() flow for rect/circle). Then apply these targeted modifications:

**A. Extend DrawTool type** — find the existing `ShapeType` / tool type union and extend it:
```typescript
type DrawTool = 'rect' | 'circle' | 'pencil' | 'line';
```
(If ShapeType is imported from types.ts, update the local tool variable to use DrawTool union instead.)

**B. Add new private state fields** alongside existing ones:
```typescript
private activeTool: DrawTool | null = null;
// pencil state
private pencilPoints: Array<{x: number; y: number}> = [];
private isDrawingPencil = false;
// line state
private lineStart: {x: number; y: number} | null = null;
private lineEnd: {x: number; y: number} | null = null;
private arrowheadEnabled = false;
```

**C. Add DOM references** in constructor / setupEventListeners() by grabbing:
- `document.getElementById('draw-pencil-btn')` → `pencilBtn`
- `document.getElementById('draw-line-btn')` → `lineBtn`
- `document.getElementById('draw-arrowhead')` as `HTMLInputElement` → `arrowheadCheckbox`

Wire click handlers on pencilBtn and lineBtn so each calls `this.toggleTool('pencil')` / `this.toggleTool('line')` (mirroring existing rect/circle toggles). Wire `arrowheadCheckbox.addEventListener('change', ...)` to update `this.arrowheadEnabled`.

**D. Update toggleTool() (or equivalent activate/deactivate logic)** to handle 'pencil' and 'line' cases. For pencil/line tools: hide `shape-apply-btn`, set `canvas.style.cursor = 'crosshair'`, attach mouse event listeners. On deactivate: restore cursor, remove event listeners, clear pencil/line state.

**E. Pencil tool mouse events** — follow MaskBrush collect-then-commit pattern exactly:
- `mousedown`: set `isDrawingPencil = true`, init `pencilPoints = []`, add first point via `getCanvasPoint(e)`, call `editor.drawOnPreview(() => {})` once to baseline the canvas
- `mousemove` (only if `isDrawingPencil`): add point via `getCanvasPoint(e)`, draw the new segment directly on `canvas.getContext('2d')` (NOT via `editor.drawOnPreview()` — avoid full repaint per pixel per Research Pitfall 6): `ctx.strokeStyle = color; ctx.lineWidth = lineWidth; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; if (pencilPoints.length >= 2) { ctx.beginPath(); ctx.moveTo(prev.x, prev.y); ctx.lineTo(curr.x, curr.y); ctx.stroke(); }`
- `mouseup` on window: if `isDrawingPencil`, set `isDrawingPencil = false`, scale points by `1 / editor.getPreviewScale()`, call `await this.editor.applyPencil({ points: scaledPoints, color: this.color, lineWidth: Math.round(this.lineWidth / scale) })`, clear `pencilPoints`

**F. Line tool mouse events** — follow ShapeDrawer drag-preview pattern:
- `mousedown`: record `lineStart = getCanvasPoint(e)`
- `mousemove` (only if `lineStart !== null`): update `lineEnd = getCanvasPoint(e)`, call `this.editor.drawOnPreview((ctx) => { LineOperation.draw(ctx, this.buildLine()); })`
- `mouseup`: if `lineStart && lineEnd`, scale both points by `1 / editor.getPreviewScale()`, call `await this.editor.applyLine(scaledLineData)`, clear `lineStart`/`lineEnd`

**G. Add buildLine() helper**:
```typescript
private buildLine() {
  return {
    x1: this.lineStart!.x, y1: this.lineStart!.y,
    x2: this.lineEnd!.x,   y2: this.lineEnd!.y,
    color: this.color,
    lineWidth: this.lineWidth,
    arrowhead: this.arrowheadEnabled,
  };
}
```

**H. getCanvasPoint() helper** — add if not already present (mirror MaskBrush pattern):
```typescript
private getCanvasPoint(e: MouseEvent): {x: number; y: number} {
  const rect = this.canvas.getBoundingClientRect();
  return {
    x: (e.clientX - rect.left) * (this.canvas.width / rect.width),
    y: (e.clientY - rect.top)  * (this.canvas.height / rect.height),
  };
}
```
(ShapeDrawer may already have coordinate conversion — check before adding.)

**I. Import additions** at the top of ShapeDrawer.ts:
```typescript
import { PencilOperation } from '../operations/PencilOperation';
import { LineOperation } from '../operations/LineOperation';
import { PencilStroke, LineData } from '../types';
```

**IMPORTANT:** Do NOT break existing rect/circle functionality. The existing `renderPreview()`, `commit()`, and shape-apply-btn logic for rect/circle must remain intact. Only add new branches for 'pencil' and 'line' tool modes.
  </action>
  <verify>
    <automated>cd /Users/iedo/Study/photo-editor && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Run `npm run dev`, open browser, activate Draw tab, select pencil tool, draw a stroke — verify it commits to the image.</manual>
  </verify>
  <done>ShapeDrawer handles all four tools; TypeScript compiles clean; existing rect/circle tools not broken</done>
</task>

<task type="auto">
  <name>Task 3: Add HTML controls and keyboard shortcuts</name>
  <files>index.html, src/ui/KeyboardShortcuts.ts</files>
  <action>
**index.html — add pencil button, line button, and arrowhead checkbox to panel-draw:**

Locate the `#panel-draw` div (or `id="panel-draw"` section). Add the following controls BEFORE the existing shape buttons (shape-rect-btn, shape-circle-btn), following the exact same HTML structure as existing buttons in the panel (check existing btn/btn-icon class and separator patterns):

```html
<span class="panel-label">Draw</span>
<button id="draw-pencil-btn" class="btn btn-icon" title="Pencil (P)"></button>
<button id="draw-line-btn" class="btn btn-icon" title="Line (L)"></button>
<label class="btn btn-sm" title="Arrow tip on line">
  <input type="checkbox" id="draw-arrowhead" /> Arrow
</label>
<div class="separator"></div>
```

Add Lucide icons inside the buttons using the same pattern as existing shape buttons (check how shape-rect-btn and shape-circle-btn use lucide icons — replicate that pattern for `Pencil` and `Minus` icons from lucide).

**src/ui/KeyboardShortcuts.ts — add P and L shortcuts:**

Read the existing KeyboardShortcuts.ts to find the switch/case block that handles keyboard shortcuts. Add two new cases alongside the existing ones:

```typescript
case 'p':
  (document.getElementById('draw-pencil-btn') as HTMLButtonElement)?.click();
  break;
case 'l':
  (document.getElementById('draw-line-btn') as HTMLButtonElement)?.click();
  break;
```

Guard these with the same conditions used by existing shortcuts (e.g., not firing when typing in an input). Check the existing guard pattern (likely `if (e.target instanceof HTMLInputElement) return;` or similar) and follow it exactly.
  </action>
  <verify>
    <automated>cd /Users/iedo/Study/photo-editor && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check panel-draw in browser — pencil and line buttons visible. Press P and L — verify tool activates.</manual>
  </verify>
  <done>Pencil and line buttons appear in Draw tab panel; P and L keyboard shortcuts activate the respective tools; TypeScript compiles clean</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` — zero errors. Then `npm run dev` and manually verify:
1. Draw tab is accessible, pencil and line buttons visible
2. Pencil tool: draw a freehand stroke — it appears committed on mouseup
3. Line tool: drag — live preview during drag, committed on mouseup
4. Line tool with Arrow checkbox checked: arrowhead appears at end of line
5. Rect and circle tools still work (no regression)
6. P key activates pencil, L key activates line
7. Undo (Ctrl+Z) reverts the last stroke/shape individually
</verification>

<success_criteria>
- `npx tsc --noEmit` exits 0 with no errors
- All four drawing tools are individually undoable (each mouseup = one history entry)
- Pencil strokes do not stutter (incremental draw on mousemove, not full repaint per point)
- Line preview updates live during drag
- Rect and circle tools still function identically to before this phase
</success_criteria>

<output>
After completion, create `.planning/phases/01-drawing-tools/01-02-SUMMARY.md` using the summary template.
</output>
